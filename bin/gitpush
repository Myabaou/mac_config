#!/bin/bash

while getopts ":f" opt; do
  case ${opt} in
    f )
      FORCE_MERGE=true
      ;;
    \? )
      echo "Invalid option: -$OPTARG" 1>&2
      exit 1
      ;;
    : )
      echo "Option -$OPTARG requires an argument" 1>&2
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

if [ $# -eq 0 ]
  then
    echo "No commit message supplied"
    exit 1
fi

GITADD="git add ."
echo "[INFO] ${GITADD}"
$GITADD

GITCOMMIT="[INFO] git commit -m \"$1\""
git commit -m "$1"

GITPUSH="git push -u origin head"
echo $GITPUSH
$GITPUSH

if [ -n "$FORCE_MERGE" ]
  then
    echo "[INFO] Creating pull request"
    gh pr create --title "$1" --body "$1" --base main

    echo "[INFO] Merging pull request"
    CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
    PR_NUMBER=$(gh pr list --state open --base main --head $CURRENT_BRANCH --json number | jq -r '.[] | .number')
    gh pr merge $PR_NUMBER
fi